<!DOCTYPE html><html prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#"><head><title>Choice of server architecture</title><meta http-equiv=content-type content="text/html; charset=utf-8"><meta name=description content="IndieHosters is hosting your data for your freedom not for profit!"><meta name=keywords content=""><!--[if lte IE 8]><script src="css/ie/html5shiv.js"></script><![endif]--><link rel=stylesheet href=/site.css><script src=/site.js></script><noscript><link rel=stylesheet href=/css/skel.css><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/style-desktop.css><link rel=stylesheet href=/css/style-noscript.css></noscript><link rel=canonical href=https://indiehosters.net/blog/version-0.1><link rel=apple-touch-icon sizes=57x57 href=/favicons/apple-touch-icon-57x57.png><link rel=apple-touch-icon sizes=114x114 href=/favicons/apple-touch-icon-114x114.png><link rel=apple-touch-icon sizes=72x72 href=/favicons/apple-touch-icon-72x72.png><link rel=apple-touch-icon sizes=144x144 href=/favicons/apple-touch-icon-144x144.png><link rel=apple-touch-icon sizes=60x60 href=/favicons/apple-touch-icon-60x60.png><link rel=apple-touch-icon sizes=120x120 href=/favicons/apple-touch-icon-120x120.png><link rel=apple-touch-icon sizes=76x76 href=/favicons/apple-touch-icon-76x76.png><link rel=apple-touch-icon sizes=152x152 href=/favicons/apple-touch-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/favicons/apple-touch-icon-180x180.png><meta name=apple-mobile-web-app-title content=IndieHosters><link rel=icon type=image/png href=/favicons/favicon-192x192.png sizes=192x192><link rel=icon type=image/png href=/favicons/favicon-160x160.png sizes=160x160><link rel=icon type=image/png href=/favicons/favicon-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><meta name=msapplication-TileColor content=#00aba9><meta name=msapplication-TileImage content=/favicons/mstile-144x144.png><meta name=application-name content=IndieHosters><!--[if lte IE 8]><link rel="stylesheet" href="css/ie/v8.css" /><![endif]--><meta property=og:title content="Choice of server architecture"><meta property=og:type content=website><meta property=og:site_name content=IndieHosters><meta property=og:locale content=en_US><meta property=og:url content=https://indiehosters.net/blog/version-0.1><meta property=og:description content="IndieHosters is hosting your data for your freedom not for profit!"><meta property=og:image content=https://indiehosters.net/images/posts/docker.jpg><meta property=og:image:secure_url content=https://indiehosters.net/images/posts/docker.jpg><meta property=fb:profile_id content=indiehosters><meta property=fb:admins content=776290334></head><body class=left-sidebar><div id=header><div class=inner><header><a href=/index.html><img src=/images/logo.svg></a></header></div><nav id=nav><ul><li><a href=/index.html>Home</a></li><li><a class=scrolly href=/index.html#pitch>About</a></li><li><a class=scrolly href=/index.html#blog>Blog</a></li><li><a class=scrolly href=/index.html#products>Products</a></li><li><a class=scrolly href=/index.html#claim>Claim Independence!</a></li><li><a class=scrolly href=#contact>Contact</a></li><li><a href=/devops.html>DevOps</a></li></ul></nav></div><div class="wrapper style1"><div class=container><article id=main class=special><header><h2><a href=#>Choice of server architecture</a></h2><p class=post-meta>Nov 3, 2014</p></header><a href=# class="image featured"><img src=/images/posts/docker.jpg alt=""></a><div id=article><p>We finally started running the first two IndieHosters servers! This website is hosted on them, for instance. Version 0.1 of the server setup is really quite basic. We try to avoid writing software as much as we can, and focus on hosting software built by other people.</p><p>We want to fill the gap between the free software product that says “We’re open source! You can host this on your own server!” and the end-user, who often doesn’t want to (learn how to) host software on servers.</p><p>Hosting software on servers is often not very hard, at least not if you have some experience with using the Linux command-line. Of course you get better and better over the years while you do it more often, but it’s mainly a matter of following the instructions and recipes you’re given, applying a bit of common knowledge about how server software usually organizes its configuration, processes and logs, and whenever something doesn’t work, search the forums for a solution.</p><h2 id=why-we-chose-a-generic-setup>Why we chose a generic setup</h2><p>We chose a Docker+systemd setup, for several reasons. First, we want to be able to offer any personal server application anybody may want. This means we don’t want to commit to a specific personal server management tool. There are several projects that are working on graphical user interfaces for server administration. They are like “meta software”: it’s software you install once, using the Linux command-line (or it comes preinstalled on a physical device you buy), and after that it works like a graphical “app store”, where you can install other software (sometimes called apps, plugins, etcetera) very easily (typically with one click on some “Install” icon).</p><p>Examples of such generic meta-software projects are:</p><ul><li><a href="https://freedomboxfoundation.org/">FreedomBox</a></li><li><a href=https://sandstorm.io>SandStorm</a></li><li><a href="https://yunohost.org/">Y-U-No-Host</a></li><li><a href="https://owncloud.org/">ownCloud</a> (where apps need to be PHP)</li><li><a href="https://cozy.io/">CozyCloud</a> (where apps need to be NodeJS)</li></ul><p>We want to offer hosting for all these products, as well as for more specific server applications like postfix (email), Wordpress (blogging), etcetera. We also want to help small and young free software projects to gain traction by offering hosting for them before the big hosting companies do this.</p><h2 id=why-we-chose-docker>Why we chose Docker</h2><p>A lot of applications are available as LAMP applications, and by using Docker, we can easily offer all of these in a safe containerized environment. If one of these applications contains a cross-site scripting or SQL injection vulnerability, then this should stay entirely sandboxed, and not affect the other applications the user runs. Docker provides this separation, as it is based on Linux containers. Also, Dockerfiles provide an easy way to script the install steps of any Linux-based application in a reproducible way. For instance, this website has a <a href=https://github.com/indiehosters/website/blob/source/Dockerfile>Dockerfile</a> which specifies exactly which version of grunt and jekyll you need to build it from the markdown source, and because the build happens in a Docker container, someone building it on an Ubuntu laptop gets exactly the same output as someone else building it on a Macbook.</p><p>By using Dockerfiles to describe exactly, and reproducibly, which application and configuration get installed on a server, we will be able to easily offer hosting for hundreds of personal server setups, on a generic application-agnostic hosting stack. Yet we are being very careful not to add a layer of software ourselves. We only translate the build instructions of the upstream project to a Dockerfile, configure which port should be opened, and Docker does the rest.</p><p>Apart from containerization, and reproducible build instructions, another great feature are Docker volumes. As containers run, they have the possibility to build up state: files like logs and user data change on the container’s internal filesystem, relative to their virgin state. When you reset (i.e., stop, remove, and start) the container, this state is reset to the initial virgin state.</p><p>By mounting volumes from the host system into a Docker container for exactly the data you want to persist, this can be avoided. That we, we can specify exactly what parts of the file system tree we consider “user data”, and which parts are either part of the image, or can be reset to their virgin content from the image without affecting the application. This way, it is even possible to reset a container to its initial state in between two http requests - as long as the place where the user sessions are stored is marked as data we want to mount in from the host system, so that it is preserved across container resets.</p><h2 id=why-we-chose-systemd>Why we chose systemd</h2><p>We could of course use Docker directly from the command line. We could write some simple bash scripts that call the right Docker commands for adding and removing processes on a server. However, there are a number of things that would be awkward to do from plain bash scripts. For instance, only schedule a git pull for those websites which have been configured with the option to pull their content from some git repository, and not for others. Or, making sure the webserver starts after the database server, and only if the database server was started successfully.</p><p>For this, we use systemd. It handles the dependencies between different containers, organizes the specific Docker commands we want to be executed to achieve different goals into its unit files syntax, and also replaces crontab. In line with the <a href="https://coreos.com/">CoreOS</a> philosophy for running lean host systems for Docker hosting, we also use etcd to keep track of some system state (e.g. which application is currently listening on which IP on the internal network), and confd templating to generate for instance the haproxy config file.</p><h2 id=version-01-now-available>Version 0.1 now available!</h2><p>We tagged a <a href=https://github.com/indiehosters/indiehosters/releases>version 0.1</a> in the repository containing our systemd unit files. It contains basically two scripts: one script for setting up a server with one default domain on there, and one scripts for adding another site to it. You can try it out using the instructions in the README (using Vagrant is the easiest way to see the development version running on your laptop).</p><p>In this first initial version, the functionality is still very limited: it allows you to host several website over https on one IPv4 address using the SNI feature of haproxy. Each site can pull from a git repository every 10 minutes, or you can just ssh to the host system to edit its html content. The backends run plain nginx in this version, so no php or mysql is available.</p><p>Additionally, a <a href=https://github.com/indiehosters/dockerfiles/blob/master/server-wide/postfix/Dockerfile>postfix-forwarder</a> is included which will forward email to a secondary address. See the <a href=https://github.com/indiehosters/indiehosters/tree/master/data/server-wide/postfix>data</a> folder of the IndieHosters repo for an example of how to configure it.</p><p>To get a feel for what such unit files look like, check out the <a href=https://github.com/indiehosters/indiehosters/blob/master/unit-files/wordpress%40.service>unit-files</a> folder.</p><p>Feedback welcome! We’re already making a lot of progress on version 0.2, which will include the necessary unit files for hosting LAMP applications like Wordpress and ownCloud.</p><div></div></div></article></div></div><!-- Footer --><div id=footer><div class=container><div class=row><!-- Blog --><section id=blog class=6u><header><a href=/blog><h2 class="icon fa-file circled"><span class=label>Blog</span></h2></a></header><ul class=divided><li><article class="blog stub"><header><h4><a href=/blog/ouishare-awards>Ouishare Awards</a></h4></header><span class=timestamp>May 6, 2015</span></article></li><li><article class="blog stub"><header><h4><a href=/blog/signup-open>Signup now open</a></h4></header><span class=timestamp>Feb 27, 2015</span></article></li><li><article class="blog stub"><header><h4><a href=/blog/StartPage>The Start Page</a></h4></header><span class=timestamp>Dec 1, 2014</span></article></li></ul></section><!-- Team --><section class=6u><header><h2 class="icon fa-heart circled"><span class=label>Blog</span></h2></header><header><p>Made with love by:</p></header><div class="row quarter no-collapse"><div class=6u><center><a href="https://michielbdejong.com/" class="image fit"><img class=circled src=/images/michielbdejong.png alt=""> Michiel de Jong</a></center></div><div class=6u><center><a href="http://pierre-o.fr/" class="image fit"><img class=circled src=/images/pierreozoux.png alt=""> Pierre Ozoux</a></center></div></div></section></div><hr><section id=cta class=contact><h2>Subscribe to our NewsLetter</h2><p>We'd love to let you informed when we reach significative milestones on our project, if you too, please subscribe!</p><form method=post action=https://subscribe.indiehosters.net/wp-content/plugins/newsletter/do/subscribe.php><div class="row half"><div class="4u -3u"><input name=ne id=email placeholder="Email Address" type=email></div><div class=2u><input value=Subscribe class=fit type=submit></div></div></form></section><hr><div class=row><div class=12u><!-- Contact --><section id=contact class=contact><header><h3>We're also social :)</h3></header><p>If you want to contact us, or follow us, we have a lot of options for you!</p><ul class=icons><li><a target=_blank href=https://indiehosters.net/feed.xml class="icon fa-rss"><span class=label>RSS</span></a></li><li><a target=_blank rel=me href=https://twitter.com/indiehosters class="icon fa-twitter"><span class=label>Twitter</span></a></li><li><a target=_blank rel=me href=https://github.com/indiehosters class="icon fa-github"><span class=label>GitHub</span></a></li><li><a target=_blank href="https://gratipay.com/for/indiehosters/" class="icon fa-heart"><span class=label>Gratipay</span></a></li><li><a target=_blank rel=me href=https://www.facebook.com/pages/IndieHosters/821708187873692 class="icon fa-facebook"><span class=label>Facebook</span></a></li><li><a target=_blank rel=me href=mailto:contact@indiehosters.net class="icon fa-envelope-o"><span class=label>Facebook</span></a></li><li><a target=_blank rel=me href=irc://chat.freenode.net/indiehosters class=icon title="IRC: #indiehosters">#<span class=label>IRC</span></a></li></ul></section><!-- Copyright --><div class=copyright><ul class=menu><li><img src=/images/cc-zero.svg></li><li>Design: <a href=http://html5up.net target=_blank>HTML5 UP</a></li><li>Logo: <a href=http://www.camille-simermann.com/fr target=_blank>Camille Simermann</a></li></ul></div></div></div></div></div><!-- Piwik --><script type=text/javascript>var _paq = _paq || [];
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//stats.pierre-o.fr/";
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['setSiteId', 3]);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
  })();</script><noscript><p><img src="//stats.pierre-o.fr/piwik.php?idsite=3" style=border:0 alt=""></p></noscript><!-- End Piwik Code --></body></html>